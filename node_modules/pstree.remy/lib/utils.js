const spawn = require('child_process').spawn;

module.exports = { tree, pidsForTree, getStat };

function getStat() {
  return new Promise((resolve) => {
    const command = `ls /proc | grep -E '^[0-9]+$' | xargs -I{} cat /proc/{}/stat`;
    const spawned = spawn('sh', ['-c', command], {
      stdio: ['pipe', 'pipe', 'pipe'],
    });

    var res = '';
    spawned.stdout.on('data', (data) => (res += data));
    spawned.on('close', () => resolve(res));
  });
}

function template(s) {
  var stat = null;
  // 'pid', 'comm', 'state', 'ppid', 'pgrp'
  // %d     (%s)    %c       %d      %d
  s.replace(
    /(\d+) \((.*?)\)\s(.+?)\s(\d+)\s/g,
    (all, PID, COMMAND, STAT, PPID) => {
      stat = { PID, COMMAND, PPID, STAT };
    }
  );

  return 